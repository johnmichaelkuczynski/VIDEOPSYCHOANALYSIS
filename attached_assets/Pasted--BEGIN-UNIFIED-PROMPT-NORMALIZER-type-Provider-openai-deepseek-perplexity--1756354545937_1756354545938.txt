// === BEGIN UNIFIED PROMPT + NORMALIZER ===

type Provider = "openai" | "deepseek" | "perplexity" | "anthropic";

export function buildPrompt(provider: Provider) {
  if (provider === "anthropic") {
    return `
You are provided transcript text and context. 
You must answer ALL items below with concrete, specific content. 
No omissions. No exceptions. No qualifications. Output MUST be valid JSON only.

[Section 1: Core 1-20]
1. What drives this person (their core motivation)?
2. How confident are they really?
3. Do they genuinely like themselves?
4. How smart are they?
5. How creative are they?
6. How do they handle stress or setbacks?
7. Are they trustworthy?
8. Do they exaggerate or fake things about themselves?
9. How ambitious are they?
10. What are they insecure about?
11. How much do they care what others think?
12. Are they independent-minded, or do they follow the crowd?
13. Do they tend to dominate conversations or listen more?
14. How do they deal with criticism?
15. Are they more optimistic or pessimistic?
16. Do they have a strong sense of humor?
17. How do they treat people “beneath” them?
18. Are they consistent, or do they contradict themselves?
19. What hidden strengths do they have?
20. What hidden weaknesses do they have?

[Section 2: 40-60 Personality]
21. What do they crave most — attention, respect, control, affection, or freedom?
22. Do they secretly feel superior or inferior to others?
23. How emotionally stable are they?
24. Do they take responsibility for mistakes or deflect blame?
25. How competitive are they?
26. Do they hold grudges or let things go?
27. Are they more genuine in private or in public?
28. How self-aware do they seem?
29. Do they tend to exaggerate their successes or downplay them?
30. Are they more driven by logic or by emotion?
31. Do they thrive on routine or novelty?
32. Are they better at starting things or finishing them?
33. Do they inspire others, drain others, or blend into the background?
34. Are they risk-takers or risk-avoiders?
35. Do they tend to manipulate people, charm them, or stay straightforward?
36. How consistent is their image of themselves compared to reality?
37. Do they prefer to lead, to follow, or to go it alone?
38. Are they generous with others, or more self-serving?
39. Do they seek depth in relationships, or keep things shallow?
40. What do they most want to hide from others?
41. Do they adapt quickly, or resist change?
42. How much do they exaggerate their life story?
43. Are they more focused on short-term pleasure or long-term goals?
44. Do they secretly feel underappreciated?
45. How much control do they need in relationships?
46. Do they have hidden anger or resentment?
47. Are they better at giving advice or taking it?
48. Do they come across as more authentic or performative?
49. How curious are they about the world and other people?
50. Do they stick to their principles, or bend them when convenient?
51. How good are they at reading others?
52. Do they act the same across different social groups, or change their persona?
53. Do they seek excitement or avoid it?
54. Do they like being the center of attention, or prefer staying in the background?
55. Do they overshare, undershare, or strike a balance?
56. Are they more forgiving or judgmental?
57. Do they use humor as connection, or as defense?
58. Are they decisive, or do they hesitate a lot?
59. Do they need constant validation, or are they self-sustaining?
60. What’s the gap between how they want to be seen and how they actually appear?

[Section 3: Visual Markers]
- Affect & Emotional Expression
- Gaze & Eyes
- Facial Expression & Micro-Expression
- Speech/Mouth Indicators
- Posture & Psychomotor Signs
- Attachment/Relational Cues
- Defensive Operations
- Cognitive/Neurological Style (Inferred)
- Sexual/Behavioral Pathology Indicators
- Global Integration & Breakdown

[Section 4: Textual/Verbal Markers]
- Affect in Language
- Gaze/Attention Equivalents
- Expression Style / Syntax
- Content of Speech
- Relational / Attachment Language
- Defenses in Language
- Cognitive Organization
- Psychomotor/Behavioral Equivalents in text
- Global Integration
- Markers of Psychotic Process

Return a single JSON object with keys:
core_questions, personality_40_60, visual_markers, textual_markers.
Each key must contain detailed sub-answers for ALL items.
    `.trim();
  }

  // Default for OpenAI/DeepSeek/Perplexity (direct image/video wording)
  return `
Analyze the uploaded image or video directly. 
You must answer ALL items below with concrete, specific content. 
No omissions. No exceptions. No qualifications. Output MUST be valid JSON only.

[Section 1: Core 1-20]
1. What drives this person (their core motivation)?
2. How confident are they really?
3. Do they genuinely like themselves?
4. How smart are they?
5. How creative are they?
6. How do they handle stress or setbacks?
7. Are they trustworthy?
8. Do they exaggerate or fake things about themselves?
9. How ambitious are they?
10. What are they insecure about?
11. How much do they care what others think?
12. Are they independent-minded, or do they follow the crowd?
13. Do they tend to dominate conversations or listen more?
14. How do they deal with criticism?
15. Are they more optimistic or pessimistic?
16. Do they have a strong sense of humor?
17. How do they treat people “beneath” them?
18. Are they consistent, or do they contradict themselves?
19. What hidden strengths do they have?
20. What hidden weaknesses do they have?

[Section 2: 40-60 Personality]
21. What do they crave most — attention, respect, control, affection, or freedom?
22. Do they secretly feel superior or inferior to others?
23. How emotionally stable are they?
24. Do they take responsibility for mistakes or deflect blame?
25. How competitive are they?
26. Do they hold grudges or let things go?
27. Are they more genuine in private or in public?
28. How self-aware do they seem?
29. Do they tend to exaggerate their successes or downplay them?
30. Are they more driven by logic or by emotion?
31. Do they thrive on routine or novelty?
32. Are they better at starting things or finishing them?
33. Do they inspire others, drain others, or blend into the background?
34. Are they risk-takers or risk-avoiders?
35. Do they tend to manipulate people, charm them, or stay straightforward?
36. How consistent is their image of themselves compared to reality?
37. Do they prefer to lead, to follow, or to go it alone?
38. Are they generous with others, or more self-serving?
39. Do they seek depth in relationships, or keep things shallow?
40. What do they most want to hide from others?
41. Do they adapt quickly, or resist change?
42. How much do they exaggerate their life story?
43. Are they more focused on short-term pleasure or long-term goals?
44. Do they secretly feel underappreciated?
45. How much control do they need in relationships?
46. Do they have hidden anger or resentment?
47. Are they better at giving advice or taking it?
48. Do they come across as more authentic or performative?
49. How curious are they about the world and other people?
50. Do they stick to their principles, or bend them when convenient?
51. How good are they at reading others?
52. Do they act the same across different social groups, or change their persona?
53. Do they seek excitement or avoid it?
54. Do they like being the center of attention, or prefer staying in the background?
55. Do they overshare, undershare, or strike a balance?
56. Are they more forgiving or judgmental?
57. Do they use humor as connection, or as defense?
58. Are they decisive, or do they hesitate a lot?
59. Do they need constant validation, or are they self-sustaining?
60. What’s the gap between how they want to be seen and how they actually appear?

[Section 3: Visual Markers]
- Affect & Emotional Expression
- Gaze & Eyes
- Facial Expression & Micro-Expression
- Speech/Mouth Indicators
- Posture & Psychomotor Signs
- Attachment/Relational Cues
- Defensive Operations
- Cognitive/Neurological Style (Inferred)
- Sexual/Behavioral Pathology Indicators
- Global Integration & Breakdown

[Section 4: Textual/Verbal Markers]
- Affect in Language
- Gaze/Attention Equivalents
- Expression Style / Syntax
- Content of Speech
- Relational / Attachment Language
- Defenses in Language
- Cognitive Organization
- Psychomotor/Behavioral Equivalents in text
- Global Integration
- Markers of Psychotic Process

Return a single JSON object with keys:
core_questions, personality_40_60, visual_markers, textual_markers.
Each key must contain detailed sub-answers for ALL items.
  `.trim();
}

export function normalizeResult(raw: string) {
  let result: any;
  try {
    result = JSON.parse(raw);
  } catch {
    // Attempt to extract JSON substring if model wrapped it in prose
    const m = raw.match(/\{[\s\S]*\}$/);
    result = m ? JSON.parse(m[0]) : {};
  }

  const requiredTopKeys = ["core_questions","personality_40_60","visual_markers","textual_markers"];
  for (const k of requiredTopKeys) {
    if (!result[k]) result[k] = {};
  }
  function ensure(obj: any, key: string, fallback: any = "N/A") {
    if (obj[key] === undefined || obj[key] === null || obj[key] === "") obj[key] = fallback;
  }

  // Core 1–20
  for (let i = 1; i <= 20; i++) { ensure(result.core_questions, String(i)); }
  // 40–60
  for (let i = 21; i <= 60; i++) { ensure(result.personality_40_60, String(i)); }

  // Visual subsections
  ["affect","gaze","facial","mouth","posture","attachment","defenses",
   "cognitive_neuro","sexual_behavioral","global_integration"]
   .forEach(s => ensure(result.visual_markers, s, "N/A"));

  // Textual subsections
  ["affect","gaze_attention","expression_syntax","content","relational",
   "defenses","cognitive_org","psychomotor_text","global_integration","psychotic_process"]
   .forEach(s => ensure(result.textual_markers, s, "N/A"));

  return result;
}
// === END UNIFIED PROMPT + NORMALIZER ===
